var Snapback=function(t,e){var i=this;this.config="string"==typeof e.preset?_.merge(this.presets[e.preset],e):e,this.element=t,this.undos=[],this.mutations=[],this.undoIndex=-1,this.enabled=!1,this.selectron=this.config.selectron?this.config.selectron:null,this.positron=this.selectron?this.getPositron():null,this.observer=new MutationObserver(function(t){t.forEach(function(t){switch(t.type){case"childList":var e=i.config.typing?i.fixType(t):!1;e||i.addMutation(t);break;case"attributes":i.addMutation(t);break;case"characterData":i.addMutation(t)}})})};Snapback.prototype={presets:{standard:{mutationObserver:{subtree:!0,childList:!0},typing:!1},spytext:{mutationObserver:{subtree:!0,attributeFilter:["style"],attributes:!0,attributeOldValue:!0,childList:!0,characterData:!0,characterDataOldValue:!0},typing:!0}},addMutation:function(t){switch(t.type){case"characterData":t.newValue=t.target.textContent;var e=this.mutations.length-1;e>-1&&"characterData"===this.mutations[e].type&&this.mutations[e].target===t.target&&this.mutations[e].newValue===t.oldValue?this.mutations[e].newValue=t.newValue:this.mutations.push(t);break;case"attributes":t.newValue=t.target.getAttribute(t.attributeName),this.mutations.push(t);break;case"childList":this.mutations.push(t)}},redo:function(){this.enabled&&this.undoIndex<this.undos.length-1&&(this.undoIndex++,this.undoRedo(this.undos[this.undoIndex],!1))},fixType:function(t){var e=!1,i=this;return this.disable(),t.target===this.element?_.each(t.addedNodes,function(t){if(3===t.nodeType||"div"===t.nodeName.toLowerCase()){e=!0;var n=""!==t.textContent?t.textContent:"<br />",s=O("<p>"+n+"</p>");t.replaceWith(s),i.selectron.set(s,s.textContent.length),i.addMutation({type:"childList",addedNodes:[s],removedNodes:[],target:s.parentNode,nextSibling:s.nextSibling,previousSibling:s.previousSibling})}}):_.each(t.addedNodes,function(n){if(1===n.nodeType&&(n.removeAttribute("style"),"span"===n.nodeName.toLowerCase())){var s=i.getPositron();if(e=!0,n.firstChild&&n.textContent.length>0){var o=n.previousSibling,a=n.nextSibling;if(n.vanish(),o){var r=o.textContent;o.textContent=r+n.textContent,i.addMutation({type:"characterData",target:o,oldValue:r,newValue:o.textContent})}else for(;n.firstChild;){var d=n.firstChild;a?a.before(n.firstChild):t.target.append(d),i.addMutation({type:"childList",addedNodes:[d],removedNodes:[],target:t.target,previousSibling:null,nextSibling:a})}}else n.vanish();s.restore()}}),this.enable(),e},register:function(){if(this.enabled&&this.mutations.length>0){this.undoIndex<this.undos.length-1&&(this.undos=this.undos.slice(0,this.undoIndex+1));var t;this.selectron?(t={},t.before=this.positron,t.after=this.getPositron()):t=null,this.undos.push({positrons:t,mutations:this.mutations}),this.mutations=[],this.undoIndex=this.undos.length-1}this.selectron&&this.setPositron()},setPositron:function(t){this.positron=t||this.getPositron()},getPositron:function(){return this.selectron.get()},size:function(){return this.undos.length},enable:function(){this.enabled||(this.observer.observe(this.element,this.config.mutationObserver),this.enabled=!0)},disable:function(){this.enabled&&(this.observer.disconnect(),this.enabled=!1)},undo:function(){this.enabled&&this.undoIndex>=0&&(this.undoRedo(this.undos[this.undoIndex],!0),this.undoIndex--)},undoRedo:function(t,e){this.disable();for(var i=e?t.mutations.slice(0).reverse():t.mutations,n=0;n<i.length;n++){var s=i[n];switch(s.type){case"characterData":s.target.textContent=e?s.oldValue:s.newValue;break;case"attributes":s.target.attr(s.attributeName,e?s.oldValue:s.newValue);break;case"childList":for(var o=e?s.removedNodes:s.addedNodes,a=e?s.addedNodes:s.removedNodes,r=0;r<o.length;r++)s.nextSibling?s.nextSibling.before(o[r]):s.target.append(o[r]);for(var d=0;d<a.length;d++)a[d].vanish()}}this.config.selectron&&(e?t.positrons.before.restore():t.positrons.after.restore()),this.enable()}};